{% extends 'index.html' %}
{% load static %}

{% block content %}

<main id="main" class="main">

    <!-- Messages Block -->
    {% if messages %}
    <div class="messages">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} text-center mb-2">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}
    <!-- End Messages Block -->

    <div class="pagetitle">
        <h1>Add Maintenance Record</h1>
    </div><!-- End Page Title -->

    <section class="section">
        <div class="row">
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title"></h5>

                        <!-- General Form Elements -->
                        <form method="POST" action="{% url 'add_maintenance' %}" id="maintenanceForm" novalidate>
                            {% csrf_token %}

                            <div class="row">
                                <!-- Left Column -->
                                <div class="col-md-7">
                                    <!-- Equipment -->
                                    <div class="row mb-3">
                                        <div class="col-md-12">
                                            <label for="equipment" class="form-label">Equipment</label>
                                            <select class="form-select" id="equipment" name="equipment" required>
                                                <option selected disabled value="">Select Equipment</option>
                                                {% for equipment in equipments %}
                                                <option value="{{ equipment.id }}">{{ equipment.name }}</option>
                                                {% endfor %}
                                            </select>
                                            <div class="invalid-feedback">Please select an equipment.</div>
                                        </div>
                                    </div>

                                    <!-- Assigned Technicians -->
                                    <div class="row mb-3">
                                        <div class="col-md-12">
                                            <label class="form-label">Assigned Technicians</label>
                                            <!-- Initial Technician Row -->
                                            <div class="row mb-3 technician-row">
                                                <div class="col-md-10">
                                                    <select class="form-select technician-select" name="assigned_technicians[]" required>
                                                        <option value="">Select Technician</option>
                                                        {% for technician in technicians %}
                                                        <option value="{{ technician.id }}">{{ technician.get_full_name }}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                                <div class="col-md-2">
                                                    <button type="button" class="btn btn-primary-sm mb-3 remove-technician" style="background-color:lightcoral;font-size: 12px;padding:2px 10px; " disabled>Remove</button>
                                                </div>
                                            </div>
                                            <!-- End Initial Row -->

                                            <!-- Container for Additional Rows -->
                                            <div id="additional-technicians"></div>

                                            <!-- Add More Button -->
                                            <div class="row mb-3">
                                                <div class="col-md-12">
                                                    <button type="button" class="btn btn-primary-sm mb-3" style="background-color:lightgreen;font-size: 12px;padding:5px 10px; "id="add-technician">
                                                        <i class="bi bi-plus-circle"></i> Add Technician
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    

                                    <!-- Branch -->
                                    <div class="row mb-3">
                                        <div class="col-md-12">
                                            <label for="branch" class="form-label">Branch</label>
                                            <input type="text" class="form-control" id="branch" name="branch" value="{{ branch.name }}" readonly>
                                            <input type="hidden" name="branch" value="{{ branch.id }}"> <!-- Hidden field for branch ID -->
                                            <div class="invalid-feedback">Please select a branch.</div>
                                        </div>
                                    </div>

                                    <!-- Maintenance Type -->
<div class="row mb-3">
    <div class="col-md-12">
        <label for="maintenance_type" class="form-label">Maintenance Type</label>
        <select class="form-select" id="maintenance_type" name="maintenance_type" required>
            <option selected disabled value="">Select Maintenance Type</option>
            <option value="daily">Daily</option>
            <option value="weekly">Weekly</option>
            <option value="monthly">Monthly</option>
            <option value="biannually">Biannual</option>
            <option value="annually">Annual</option>
        </select>
        <div class="invalid-feedback">Please select a maintenance type.</div>
    </div>
</div>

<!-- Tasks Section -->
<div id="tasks-section" class="d-none">
    <div class="row mb-3">
        <div class="col-md-12">
            <label class="form-label">Tasks</label>
            <div class="card">
                <div class="card-body">
                    <div id="tasks-list" class="list-group">
                        <!-- Tasks will be dynamically added here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
                                    <!-- Spare Parts Section -->
                                    <div class="row mb-3">
                                        <div class="col-md-12">
                                            <label class="form-label">Spare Parts</label>
                                            <!-- Initial Spare Part and Quantity Row -->
                                            <div class="row mb-3 spare-part-row">
                                                <div class="col-md-6">
                                                    <select class="form-select spare-part-select" name="spare_parts[]">
                                                        <option value="">Select Spare Part</option>
                                                        {% for spare_part in spare_parts %}
                                                        <option value="{{ spare_part.id }}" data-quantity="{{ spare_part.quantity }}">
                                                            {{ spare_part.name }} ({{ spare_part.quantity }} available)
                                                        </option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                                <div class="col-md-4">
                                                    <input type="number" class="form-control spare-part-quantity"
                                                        name="spare_part_quantities[]" min="1" placeholder="Quantity">
                                                </div>
                                                <div class="col-md-2">
                                                    <button type="button" class="btn btn-primary-sm mb-3 remove-spare-part" style="background-color:lightcoral;font-size: 12px;padding:2px 10px; "
                                                        disabled>Remove</button>
                                                </div>
                                            </div>
                                            <!-- End Initial Row -->

                                            <!-- Container for Additional Rows -->
                                            <div id="additional-spare-parts"></div>

                                            <!-- Add More Button -->
                                            <div class="row mb-3">
                                                <div class="col-md-12">
                                                    <button type="button" class="btn btn-primary-sm mb-3" style="background-color:lightgreen;font-size: 12px;padding:5px 10px; " id="add-spare-part">
                                                        <i class="bi bi-plus-circle"></i> Add Spare Part
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Error Message Container -->
                                    <div id="errorMessages" class="alert alert-danger d-none mb-3"></div>
                                </div>

                                <!-- Right Column -->
                                <div class="col-md-4">
                                    <!-- Status -->
                                    <div class="row mb-3">
                                        <div class="col-md-12">
                                            <label for="status" class="form-label">Status</label>
                                            <select class="form-select" id="status" name="status" required>
                                                <option selected disabled value="">Select Status</option>
                                                <option value="Not Started">Not Started</option>
                                                <option value="Complete">Complete</option>
                                                <option value="In Progress">In Progress</option>
                                                <option value="Failed">Failed</option>
                                            </select>
                                            <div class="invalid-feedback">Please select a status.</div>
                                        </div>
                                    </div>

                                    <!-- Remark -->
                                    <div class="row mb-3">
                                        <div class="col-md-12">
                                            <label for="remark" class="form-label">Remark</label>
                                            <textarea class="form-control" id="remark" name="remark"
                                                rows="3"></textarea>
                                        </div>
                                    </div>

                                    <!-- Procedure -->
                                    <div class="row mb-3">
                                        <div class="col-md-12">
                                            <label for="procedure" class="form-label">Procedure</label>
                                            <textarea class="form-control" id="procedure" name="procedure"
                                                rows="3"></textarea>
                                        </div>
                                    </div>

                                    <!-- Problems -->
                                    <div class="row mb-3">
                                        <div class="col-md-12">
                                            <label for="problems" class="form-label">Problems</label>
                                            <textarea class="form-control" id="problems" name="problems"
                                                rows="3"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Submit Button -->
                            <div class="row mb-3">
                                <div class="col-md-12 text-center">
                                    <button type="submit" class="btn btn-primary">Submit</button>
                                </div>
                            </div>
                        </form><!-- End General Form Elements -->
                    </div>
                </div>
            </div>
        </div>
    </section>

</main><!-- End #main -->



<!-- Add JavaScript for Front-End Validation -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
    const maintenanceTypeSelect = document.getElementById('maintenance_type');
    const tasksSection = document.getElementById('tasks-section');
    const tasksList = document.getElementById('tasks-list');

    if (maintenanceTypeSelect && tasksSection && tasksList) {
        maintenanceTypeSelect.addEventListener('change', function () {
            const maintenanceType = this.value; // e.g., 'daily', 'weekly', etc.
            const equipmentId = document.getElementById('equipment').value;

            if (!equipmentId) {
                alert('Please select an equipment first.');
                return;
            }

            // Fetch tasks for the selected maintenance type and equipment type
            fetch(`/get-tasks/?equipment_id=${equipmentId}&maintenance_type=${maintenanceType}`)
                .then(response => response.json())
                .then(data => {
                    tasksList.innerHTML = ''; // Clear existing tasks

                    if (data.tasks.length > 0) {
                        data.tasks.forEach(task => {
                            const taskItem = document.createElement('div');
                            taskItem.className = 'list-group-item';
                            taskItem.innerHTML = `
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="tasks[]" value="${task.id}" id="task-${task.id}">
                                    <label class="form-check-label" for="task-${task.id}">
                                        ${task.description}
                                    </label>
                                </div>
                            `;
                            tasksList.appendChild(taskItem);
                        });

                        tasksSection.classList.remove('d-none'); // Show the tasks section
                    } else {
                        tasksSection.classList.add('d-none'); // Hide the tasks section if no tasks are found
                    }
                })
                .catch(error => {
                    console.error('Error fetching tasks:', error);
                });
        });
    }

    
    
        // --- Dynamic Addition of Assigned Technicians ---
        const addTechnicianButton = document.getElementById('add-technician');
        const technicianContainer = document.getElementById('additional-technicians');
    
        if (addTechnicianButton && technicianContainer) {
            addTechnicianButton.addEventListener('click', function () {
                const newRow = document.createElement('div');
                newRow.className = 'row mb-3 technician-row';
    
                newRow.innerHTML = `
                    <div class="col-md-10">
                        <select class="form-select technician-select" name="assigned_technicians[]" required>
                            <option value="">Select Technician</option>
                            {% for technician in technicians %}
                            <option value="{{ technician.id }}">{{ technician.get_full_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-primary-sm mb-3 remove-technician" style="background-color:lightcoral;font-size: 12px;padding:2px 10px; ">Remove</button>
                    </div>
                `;
    
                technicianContainer.appendChild(newRow);
    
                // Enable remove button for all rows
                document.querySelectorAll('.remove-technician').forEach(button => {
                    button.disabled = false;
                });
            });
    
            // Remove technician row
            technicianContainer.addEventListener('click', function (event) {
                if (event.target.classList.contains('remove-technician')) {
                    event.target.closest('.technician-row').remove();
    
                    // Disable remove button if only one row is left
                    if (document.querySelectorAll('.technician-row').length === 1) {
                        document.querySelector('.remove-technician').disabled = true;
                    }
                }
            });
        }
    
        // --- Dynamic Addition of Spare Parts ---
        const addSparePartButton = document.getElementById('add-spare-part');
        const sparePartContainer = document.getElementById('additional-spare-parts');
    
        if (addSparePartButton && sparePartContainer) {
            addSparePartButton.addEventListener('click', function () {
                const newRow = document.createElement('div');
                newRow.className = 'row mb-3 spare-part-row';
    
                newRow.innerHTML = `
                    <div class="col-md-6">
                        <select class="form-select spare-part-select" name="spare_parts[]">
                            <option value="">Select Spare Part</option>
                            {% for spare_part in spare_parts %}
                            <option value="{{ spare_part.id }}" data-quantity="{{ spare_part.quantity }}">
                                {{ spare_part.name }} ({{ spare_part.quantity }} available)
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <input type="number" class="form-control spare-part-quantity" name="spare_part_quantities[]" min="1" placeholder="Quantity">
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-primary-sm mb-3 remove-spare-part" style="background-color:lightcoral;font-size: 12px;padding:2px 10px; ">Remove</button>
                    </div>
                `;
    
                sparePartContainer.appendChild(newRow);
    
                // Enable remove button for all rows
                document.querySelectorAll('.remove-spare-part').forEach(button => {
                    button.disabled = false;
                });
            });
    
            // Remove spare part row
            sparePartContainer.addEventListener('click', function (event) {
                if (event.target.classList.contains('remove-spare-part')) {
                    event.target.closest('.spare-part-row').remove();
    
                    // Disable remove button if only one row is left
                    if (document.querySelectorAll('.spare-part-row').length === 1) {
                        document.querySelector('.remove-spare-part').disabled = true;
                    }
                }
            });
        }
    
        // --- Frontend Validation ---
        const form = document.getElementById('maintenanceForm');
        const errorMessagesContainer = document.getElementById('errorMessages');
    
        if (form && errorMessagesContainer) {
            form.addEventListener('submit', function (event) {
                let isValid = true;
                const errorMessages = [];
    
                // Validate required fields (excluding spare part quantities)
                const requiredFields = [
                    'equipment',
                    'assigned_technicians',
                    'branch',
                    'maintenance_task',
                    'status',
                ];
    
                requiredFields.forEach(fieldName => {
                    const field = form.querySelector(`[name="${fieldName}"]`);
                    if (!field.value) {
                        isValid = false;
                        errorMessages.push(`Please fill out the ${fieldName.replace('_', ' ')} field.`);
                        field.classList.add('is-invalid');
                    } else {
                        field.classList.remove('is-invalid');
                    }
                });
    
                if (!isValid) {
                    event.preventDefault(); // Prevent form submission
    
                    // Display error messages inline
                    errorMessagesContainer.innerHTML = errorMessages.join('<br>'); // Join messages with line breaks
                    errorMessagesContainer.classList.remove('d-none'); // Show the error container
                } else {
                    errorMessagesContainer.classList.add('d-none'); // Hide the error container if no errors
                }
            });
        }
    });
    </script>

{% endblock %}