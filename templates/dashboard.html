{% extends 'index.html' %}
{% load static %}

{% block content %}
<main id="main" class="main">
    <div class="pagetitle">
        <h1><b>Dashboard</b></h1>
        <br>
        
    </div><!-- End Page Title -->

    <section class="section dashboard">
        <!-- Summary Cards -->
        <div class="row">
            <!-- User Summary Card -->
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">User Summary</h5>
                        <div class="d-flex align-items-center">
                            <div class="card-icon rounded-circle bg-primary text-white d-flex align-items-center justify-content-center">
                                <i class="bi bi-people"></i>
                            </div>
                            <div class="ps-3">
                                <h6>Total Users: {{ total_users }}</h6>
                                <h6>Active: {{ active_users }}</h6>
                                <h6>Inactive: {{ inactive_users }}</h6>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Equipment Status Card -->
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Equipment Status</h5>
                        <div class="d-flex align-items-center">
                            <div class="card-icon rounded-circle bg-success text-white d-flex align-items-center justify-content-center">
                                <i class="bi bi-tools"></i>
                            </div>
                            <div class="ps-3">
                                <h6>Total Equipment: {{ equipment_count }}</h6>
                                <h6>Operational: {{ operational_count }}</h6>
                                <h6>Non-Operational: {{ non_operational_count }}</h6>
                                <h6>Under Maintenance: {{ under_maintenance_count }}</h6>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Role Distribution Chart -->
        <div class="row mt-4">
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">System-wide Role Distribution</h5>
                        <canvas id="roleDistributionChart" style="max-height: 400px;"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Branch-wise User Distribution -->
        <div class="row mt-4">
            {% for branch in branch_data %}
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">{{ branch.name }} Users</h5>
                        <canvas id="branchChart{{ forloop.counter }}" style="max-height: 250px;"></canvas>
                        <div class="text-center mt-2">
                            <small>Total: {{ branch.total }} | Active: {{ branch.active }} | Inactive: {{ branch.inactive }}</small>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Detailed Branch Table -->
        <div class="row mt-4">
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Detailed User Distribution by Branch</h5>
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Branch</th>
                                        <th>Total Users</th>
                                        <th>Active</th>
                                        <th>Inactive</th>
                                        {% for role in roles %}
                                        <th>{{ role }}</th>
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for branch in branch_data %}
                                    <tr>
                                        <td>{{ branch.name }}</td>
                                        <td>{{ branch.total }}</td>
                                        <td>{{ branch.active }}</td>
                                        <td>{{ branch.inactive }}</td>
                                        {% for role in roles %}
                                        <td>{{ branch.roles.get|default:0 }}</td>
                                        {% endfor %}
                                    </tr>
                                    {% endfor %}
                                    <tr class="table-primary">
                                        <td><strong>Total</strong></td>
                                        <td><strong>{{ total_users }}</strong></td>
                                        <td><strong>{{ active_users }}</strong></td>
                                        <td><strong>{{ inactive_users }}</strong></td>
                                        {% for role, count in role_counts.items %}
                                        <td><strong>{{ count }}</strong></td>
                                        {% endfor %}
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // System-wide Role Distribution
    const roleCtx = document.getElementById('roleDistributionChart').getContext('2d');
    new Chart(roleCtx, {
        type: 'pie',
        data: {
            labels: {{ roles|safe }},
            datasets: [{
                data: {{ role_counts|safe }},
                backgroundColor: [
                    'rgba(54, 162, 235, 0.8)',
                    'rgba(255, 99, 132, 0.8)',
                    'rgba(75, 192, 192, 0.8)',
                    'rgba(153, 102, 255, 0.8)',
                    'rgba(255, 159, 64, 0.8)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            plugins: {
                legend: { position: 'right' },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = Math.round((value / total) * 100);
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });

    // Branch-wise User Distribution Charts
    {% for branch in branch_data %}
    const branchCtx{{ forloop.counter }} = document.getElementById('branchChart{{ forloop.counter }}').getContext('2d');
    new Chart(branchCtx{{ forloop.counter }}, {
        type: 'bar',
        data: {
            labels: ['Active', 'Inactive'],
            datasets: [{
                label: 'Users',
                data: [{{ branch.active }}, {{ branch.inactive }}],
                backgroundColor: [
                    'rgba(75, 192, 192, 0.8)',
                    'rgba(255, 99, 132, 0.8)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            indexAxis: 'y',
            scales: { x: { beginAtZero: true } },
            plugins: {
                legend: { display: false },
                tooltip: { callbacks: { label: ctx => `${ctx.raw} users` } }
            }
        }
    });
    {% endfor %}
</script>
{% endblock %}