{% extends 'index.html' %}
{% load static %}

{% block content %}

<main id="main" class="main">

    <!-- Messages Block -->
    {% if messages %}
    <div class="messages">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} text-center mb-2">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}
    <!-- End Messages Block -->

    <div class="pagetitle">
        <h1><b>Edit Work Order : {{ work_order.equipment.name }}</b></h1>
        <nav>
            <ol class="breadcrumb">
              <li class="breadcrumb-item">Work Orders</a></li>
              <li class="breadcrumb-item active">Edit</li>
            </ol>
          </nav>
    </div><!-- End Page Title -->

    <section class="section">
        <div class="row">
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title"></h5>

                        <!-- General Form Elements -->
                        <form method="POST" action="{% url 'edit_work_order' work_order.id %}" id="workOrderForm"
                            novalidate>
                            {% csrf_token %}

                            <div class="row">
                                <!-- Left Column -->
                                <div class="col-md-7">
                                    <!-- Equipment -->

                                    {% if request.user.userprofile.role in "MD manager" and not request.user.is_superuser %}

                                    <!-- Equipment -->
                                    <!-- Equipment Dropdown for MD Manager -->
                                    {% if work_order.status != 'Approved' %}
                                    <div class="row mb-3">
                                        <div class="col-md-12">
                                            <label for="equipment" class="form-label">Equipment</label>
                                            <select class="form-select" id="equipment" name="equipment" required>
                                                <option value="">Select Equipment</option>
                                                {% for equipment in equipments %}
                                                <option value="{{ equipment.id }}" 
                                                {% if equipment.id == selected_equipment_id %}
                                                selected
                                                {% endif %}>
                                                    {{ equipment.name }}
                                                </option>
                                                {% endfor %}
                                            </select>
                                            <div class="invalid-feedback">Please select an equipment.</div>
                                        </div>
                                    </div>
                                    {% elif work_order.status == 'Approved' %}
                                    <div class="row mb-3">
                                        <div class="col-md-12">
                                            <label for="equipment" class="form-label">Equipment</label>
                                            <input type="text" class="form-control" id="equipment"
                                                value="{{ work_order.equipment.name }}" readonly>
                                            <div class="invalid-feedback">Please select an equipment.</div>
                                        </div>
                                    </div>
                                    {% endif %}
                                    
                                    {% elif request.user.userprofile.role in "TEC" and not request.user.is_superuser %}

                                    <div class="row mb-3">
                                        <div class="col-md-12">
                                            <label for="equipment" class="form-label">Equipment</label>
                                            <input type="text" class="form-control" id="equipment"
                                                value="{{ work_order.equipment.name }}" readonly>
                                            <div class="invalid-feedback">Please select an equipment.</div>
                                        </div>
                                    </div>
                                    {% endif %}

                                    <!-- Location -->
                                    <div class="row mb-3">
                                        <div class="col-md-12">
                                            <label for="location" class="form-label">Location</label>
                                            <input type="text" class="form-control" id="location"
                                                value="{{ work_order.location }}" readonly>

                                            <div class="invalid-feedback">Please enter the location.</div>
                                        </div>
                                    </div>
                                    <!-- Branch -->
                                    <div class="row mb-3">
                                        <div class="col-md-12">
                                            <label for="branch" class="form-label">Branch</label>
                                            <input type="text" class="form-control" id="branch"
                                                value="{{ work_order.branch.name }}" readonly>
                                            <input type="hidden" name="branch" value="{{ work_order.branch.id }}">
                                            <div class="invalid-feedback">Branch is required.</div>
                                        </div>
                                    </div>
                                    {% if request.user.userprofile.role != 'CL' %}
                                    <!-- Assigned Technicians -->
                                    <!-- Assigned Technicians Section -->
                                    <div class="row mb-3">
                                        <div class="col-md-12">
                                            <label class="form-label">Assigned Technicians</label>
                                            <!-- Always include the button in the DOM but conditionally hide/show it -->
                                            <div id="add-technician-container" style="display: {% if request.user.userprofile.role == 'MD manager' and work_order.status != 'Approved' %}block{% else %}none{% endif %};">
                                                {% for technician_id in assigned_technician_ids %}
                                                <div class="row mb-3 technician-row">
                                                    <div class="col-md-10">
                                                        <select class="form-select technician-select" name="assigned_technicians[]" required>
                                                            <option value="">Select Technician</option>
                                                            {% for technician in technicians %}
                                                                <option value="{{ technician.id }}" 
                                                                    {% if technician.id == technician_id %}selected{% endif %}>
                                                                    {{ technician.username }}
                                                                </option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <button type="button" class="btn btn-primary-sm mb-3 remove-technician"  style="background-color:lightcoral;font-size: 12px;padding:2px 10px; " disabled>Remove</button>
                                                    </div>
                                                </div>
                                                {% endfor %}
                                                <div id="additional-technicians"></div>
                                                <div class="row mb-3">
                                                    <div class="col-md-12">
                                                        <button type="button" class="btn btn-primary-sm mb-3" style="background-color:lightgreen;font-size: 12px;padding:5px 10px;" id="add-technician">
                                                            <i class="bi bi-plus-circle"></i> Add Technician
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                    
                                            <!-- For MD Manager: Show Read-Only List of Assigned Technicians if Work Order is Approved -->
                                            {% if request.user.userprofile.role == 'MD manager' and work_order.status == 'Approved' %}
                                                <ul class="list-group">
                                                    {% for technician in work_order.assigned_technicians.all %}
                                                        <li class="list-group-item">{{ technician.username }}</li>
                                                    {% empty %}
                                                        <li class="list-group-item">No technicians assigned.</li>
                                                    {% endfor %}
                                                </ul>
                                            {% endif %}
                                    
                                            <!-- For Technician: Show Read-Only List of Assigned Technicians -->
                                            {% if request.user.userprofile.role == 'TEC' or request.user.userprofile.role == 'MO' %}
                                                <ul class="list-group">
                                                    {% for technician in work_order.assigned_technicians.all %}
                                                        <li class="list-group-item">{{ technician.username }}</li>
                                                    {% empty %}
                                                        <li class="list-group-item">No technicians assigned.</li>
                                                    {% endfor %}
                                                </ul>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endif %}

                                    <!-- Spare Parts Section -->
                                    {% if request.user.userprofile.role != 'CL' %}
                                    <div class="row mb-3">
                                        <div class="col-md-12">
                                            <label class="form-label">Spare Parts</label>
                                            {% if request.user.userprofile.role == 'MD manager' or work_order.status == 'Approved' or request.user.userprofile.role == 'MO' %}
                                                <!-- For MD Manager or Approved Work Order: Show Read-Only List of Spare Parts -->
                                                <ul class="list-group">
                                                    {% for usage in spare_part_usages %}
                                                        <li class="list-group-item">
                                                            {{ usage.spare_part.name }} - Quantity Used: {{ usage.quantity_used }}
                                                        </li>
                                                    {% empty %}
                                                        <li class="list-group-item">No spare parts used.</li>
                                                    {% endfor %}
                                                </ul>
                                            {% elif request.user.userprofile.role == 'TEC' and work_order.status != 'Approved' %}
                                                <!-- For Technician: Allow Adding/Modifying Spare Parts -->
                                                {% for usage in spare_part_usages %}
                                                    <div class="row mb-3 spare-part-row">
                                                        <div class="col-md-6">
                                                            <select class="form-select spare-part-select" name="spare_parts[]">
                                                                <option value="">Select Spare Part</option>
                                                                {% for spare_part in spare_parts %}
                                                                    <option value="{{ spare_part.id }}" data-quantity="{{ spare_part.quantity }}"
                                                                        {% if spare_part.id == usage.spare_part.id %}selected{% endif %}>
                                                                        {{ spare_part.name }} ({{ spare_part.quantity }} available)
                                                                    </option>
                                                                {% endfor %}
                                                            </select>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <input type="number" class="form-control spare-part-quantity"
                                                                name="spare_part_quantities[]" min="1" placeholder="Quantity"
                                                                value="{{ usage.quantity_used }}">
                                                        </div>
                                                        <div class="col-md-2">
                                                            <button type="button" class="btn btn-danger remove-spare-part">Remove</button>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                                <div id="additional-spare-parts"></div>
                                                <div class="row mb-3">
                                                    <div class="col-md-12">
                                                        <button type="button" class="btn btn-primary-sm mb-3" style="background-color:lightgreen;font-size: 12px;padding:5px 10px; " id="add-spare-part">
                                                            <i class="bi bi-plus-circle"></i> Add Spare Part
                                                        </button>
                                                    </div>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- Right Column -->
                                <div class="col-md-4">

                                    <!-- Description -->
                                    <div class="row mb-3">
                                        <div class="col-md-12">
                                            <label for="description" class="form-label">Description</label>
                                            <textarea class="form-control" id="description" name="description" rows="3"
                                                readonly>{{ work_order.description }}</textarea>
                                            <div class="invalid-feedback">Please enter a description.</div>
                                        </div>
                                    </div>
                                    <!-- Status -->
                                    <div class="row mb-3">
                                        <div class="col-md-12">
                                            <label for="id_status" class="form-label">Status</label>
                                            <input type="text" class="form-control" id="id_status"
                                                value="{{ work_order.status }}" readonly>
                                            <div class="invalid-feedback">Please select a status.</div>
                                        </div>
                                    </div>
                                     
                                    <!-- Price -->
                                    {% if request.user.userprofile.role == 'MD manager' or request.user.userprofile.role == 'MO' %}
                                        <!-- Show price field for MD manager or MO -->
                                        <div class="row mb-3">
                                            <div class="col-md-12">
                                                <label for="id_price" class="form-label">Price</label>
                                                <input type="text" class="form-control" id="id_price"
                                                    value="{{ work_order.price }}" readonly>
                                                <div class="invalid-feedback">Please enter a valid price.</div>
                                            </div>
                                        </div>
                                    {% elif request.user.userprofile.role == 'TEC' and work_order.status == 'Price_Confirmed' or request.user.userprofile.role == 'TEC' and work_order.status == 'Approved' %}
                                        <!-- Show price field for TEC when status is Price_Confirmed -->
                                        <div class="row mb-3">
                                            <div class="col-md-12">
                                                <label for="id_price" class="form-label">Price</label>
                                                <input type="text" class="form-control" id="id_price"
                                                    value="{{ work_order.price }}" readonly>
                                                <div class="invalid-feedback">Please enter a valid price.</div>
                                            </div>
                                        </div>
                                    {% endif %}

                                    {% if request.user.userprofile.role == 'CL' and work_order.status != 'Pending' %}

                                    <div class="row mb-3">
                                        <div class="col-md-12">
                                            <label for="id_price" class="form-label">Price</label>
                                            <input type="text" class="form-control" id="id_price"
                                                value="{{ work_order.price }}" readonly>
                                            <div class="invalid-feedback">Please enter a valid price.</div>
                                        </div>
                                    </div>
                                    {% endif %}

                                    {% if request.user.userprofile.role == 'TEC' and work_order.status == 'Accepted' or request.user.userprofile.role == 'TEC' and work_order.status == 'Price_Estimated'  %}

                                    <div class="row mb-3">
                                        <div class="col-md-12">
                                            <label for="id_price" class="form-label">Price</label>
                                            <input type="number" class="form-control" id="id_price" name="price"
                                                value="{{ work_order.price }}" step="0.01" min="0">
                                            <div class="invalid-feedback">Please enter a valid price.</div>
                                        </div>
                                    </div>
                                     {% endif %}
                                    <!-- Remark -->
                                    {% if request.user.userprofile.role == 'MD manager' or work_order.status == 'Approved' or request.user.userprofile.role == 'MO' %}
                                        <!-- Read-only Remark Field -->
                                        <div class="row mb-3">
                                            <div class="col-md-12">
                                                <label for="remark" class="form-label">Remark</label>
                                                <textarea class="form-control" id="remark" name="remark" rows="3" readonly>{{ work_order.remark|default:"" }}</textarea>
                                            </div>
                                        </div>
                                    {% elif request.user.userprofile.role == 'TEC' and work_order.status != 'Approved' %}
                                        <!-- Updatable Remark Field -->
                                        <div class="row mb-3">
                                            <div class="col-md-12">
                                                <label for="remark" class="form-label">Remark</label>
                                                <textarea class="form-control" id="remark" name="remark" rows="3">{{ work_order.remark|default:"" }}</textarea>
                                            </div>
                                        </div>
                                    {% endif %}
                                    <div class="row mb-3 text-center">
                                        <div class="col-md-12">
                                            {% if request.user.userprofile.role == 'MD manager' %}
                                            {% if work_order.status == 'Pending' %}
                                            <a href="{% url 'accept_work_order' work_order.id %}"
                                                class="btn btn-warning">Accept</a>
                                            {% elif work_order.status == 'Complete' %}
                                            <a href="{% url 'approve_work_order' work_order.id %}"
                                                class="btn btn-primary">Approve</a>
                                            <a href="{% url 'reject_work_order' work_order.id %}"
                                                class="btn btn-danger">Reject</a>
                                            {% endif %}
                                            {% elif request.user.userprofile.role == 'TEC' %}
                                            {% if work_order.status == 'Price_Confirmed' or work_order.status == 'Rejected' %}
                                            <a href="{% url 'complete_work_order' work_order.id %}"
                                                class="btn btn-success">Complete</a>
                                            
                                            {% endif %}
                                            {% elif request.user.userprofile.role == 'CL' %}
                                            {% if work_order.status == 'Price_Estimated' %}
                                            <a href="{% url 'confirm_price' work_order.id %}"
                                            class="btn btn-success">Confirm Price</a>
                                            {% endif %}
                                            {% endif %}
                                        </div>
                                    </div>

                                    <!-- Submit Button -->


                                    <div class="row mb-3">
                                        <div class="col-md-12 text-center">
                                            <button type="submit" class="btn btn-primary">
                                                {% if request.user.userprofile.role == 'TEC' %}
                                                    {% if work_order.status == 'Accepted' or work_order.status == 'Price_Estimated' %}
                                                        Estimate Price
                                                    {% else %}
                                                        Save Changes
                                                    {% endif %}
                                                {% else %}
                                                    Save Changes
                                                {% endif %}
                                            </button>

                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form><!-- End General Form Elements -->
                    </div>
                </div>
            </div>
        </div>
    </section>

</main><!-- End #main -->

<!-- Add JavaScript for Front-End Validation -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const addSparePartButton = document.getElementById('add-spare-part');
        const sparePartContainer = document.getElementById('additional-spare-parts');
        const addTechnicianButton = document.getElementById('add-technician');
        const technicianContainer = document.getElementById('additional-technicians');
        const form = document.getElementById('workOrderForm');

        // Add new spare part row
        if (addSparePartButton && sparePartContainer) {
            addSparePartButton.addEventListener('click', function () {
                const newRow = document.createElement('div');
                newRow.className = 'row mb-3 spare-part-row';

                newRow.innerHTML = `
                    <div class="col-md-6">
                        <select class="form-select spare-part-select" name="spare_parts[]">
                            <option value="">Select Spare Part</option>
                            {% for spare_part in spare_parts %}
                            <option value="{{ spare_part.id }}" data-quantity="{{ spare_part.quantity }}">
                                {{ spare_part.name }} ({{ spare_part.quantity }} available)
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <input type="number" class="form-control spare-part-quantity" name="spare_part_quantities[]" min="1" placeholder="Quantity">
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-primary-sm mb-3 remove-spare-part" style="background-color:lightcoral;font-size: 12px;padding:2px 10px; ">Remove</button>
                    </div>
                `;

                sparePartContainer.appendChild(newRow);
            });

            // Remove spare part row
            sparePartContainer.addEventListener('click', function (event) {
                if (event.target.classList.contains('remove-spare-part')) {
                    event.target.closest('.spare-part-row').remove();
                }
            });
        }

        // Add new technician row
        if (addTechnicianButton && technicianContainer) {
            addTechnicianButton.addEventListener('click', function () {
                const newRow = document.createElement('div');
                newRow.className = 'row mb-3 technician-row';

                newRow.innerHTML = `
                    <div class="col-md-10">
                        <select class="form-select technician-select" name="assigned_technicians[]" required>
                            <option value="">Select Technician</option>
                            {% for technician in technicians %}
                            <option value="{{ technician.id }}">{{ technician.username }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-primary-sm mb-3 remove-technician" style="background-color:lightcoral;font-size: 12px;padding:2px 10px; ">Remove</button>
                    </div>
                `;

                technicianContainer.appendChild(newRow);
            });

            // Remove technician row
            technicianContainer.addEventListener('click', function (event) {
                if (event.target.classList.contains('remove-technician')) {
                    event.target.closest('.technician-row').remove();
                }
            });
        }
    });
</script>

{% endblock %}