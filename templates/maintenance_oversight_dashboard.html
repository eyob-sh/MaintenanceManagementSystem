{% extends 'index.html' %}
{% load static %}

{% block content %}
<main id="main" class="main">
    <div class="pagetitle">
        <h1>Dashboard</h1>
        <br>

        <!-- Date Range Filter -->
        <form method="get" class="row g-3">
            <div class="col-md-2">
                <label for="from_date" class="form-label">From</label>
                <input type="date" class="form-control form-control-sm" id="from_date" name="from_date" value="{{ from_date }}">
            </div>
            <div class="col-md-2">
                <label for="to_date" class="form-label">To</label>
                <input type="date" class="form-control form-control-sm" id="to_date" name="to_date" value="{{ to_date }}">
            </div>
            <div class="col-md-3">
                <label for="branch" class="form-label">Branch</label>
                <select class="form-select form-select-sm" id="branch" name="branch">
                    <option value="all" {% if selected_branch == 'all' %}selected{% endif %}>All Branches</option>
                    {% for branch in all_branches %}
                        <option value="{{ branch.id }}" {% if selected_branch == branch.id|stringformat:"s" %}selected{% endif %}>{{ branch.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary btn-sm mt-4">Apply Filter</button>
            </div>

            <div class="col-md-1">
                <label for="format" class="form-label">Format</label>
                <select class="form-select form-select-sm" id="format" name="format">
                    <option value="pdf">PDF</option>
                    <option value="docx">DOCX</option>
                </select>
            </div>

            <div class="col-md-2">
                <label for="report_type" class="form-label">Generate Report</label>
                <select class="form-select form-select-sm" id="report_type" name="report_type">
                    <option value="daily">Daily</option>
                    <option value="weekly">Weekly</option>
                    <option value="monthly">Monthly</option>
                    <option value="biannual">Biannual</option>
                    <option value="annual">Annual</option>
                    <option value="work_order">Work Order</option>
                </select>
                <button type="submit" class="btn btn-secondary btn-sm mt-2" formaction="{% url 'generate_report' %}">Generate Report</button>
            </div>
        </form>
    </div><!-- End Page Title -->

    <section class="section dashboard">
        <div class="row">
            <!-- Equipment Status Card -->
            <div class="col-xxl-3 col-md-4">
                <div class="card info-card sales-card">
                    <div class="card-body">
                        <h5 class="card-title" style="font-size: 14px;">Equipment Status</h5>
                        <p class="card-subtitle mb-2 text-muted" style="font-size: 12px;">{{ from_date }} to {{ to_date }}</p>
                        <div class="d-flex align-items-center">
                            <div class="card-icon rounded-circle d-flex align-items-center justify-content-center" style="font-size: 14px;">
                                <i class="bi bi-tools"></i>
                            </div>
                            <div class="ps-3">
                                <h6 style="font-size: 12px;">Operational: {{ operational_count }}</h6>
                                <h6 style="font-size: 12px;">Non-Operational: {{ non_operational_count }}</h6>
                                <h6 style="font-size: 12px;">Under Maintenance: {{ under_maintenance_count }}</h6>
                            </div>
                        </div>
                    </div>
                </div>
            </div><!-- End Equipment Status Card -->

            <!-- Maintenance by Frequency Card -->
            <div class="col-xxl-3 col-md-4">
                <div class="card info-card revenue-card">
                    <div class="card-body">
                        <h5 class="card-title" style="font-size: 14px;">Maintenance by Frequency</h5>
                        <p class="card-subtitle mb-2 text-muted" style="font-size: 12px;">{{ from_date }} to {{ to_date }}</p>
                        <div class="d-flex align-items-center">
                            <div class="card-icon rounded-circle d-flex align-items-center justify-content-center" style="font-size: 14px;">
                                <i class="bi bi-calendar-check"></i>
                            </div>
                            <div class="ps-3">
                                <h6 style="font-size: 12px;">Daily: {{ daily_maintenance_count }}</h6>
                                <h6 style="font-size: 12px;">Weekly: {{ weekly_maintenance_count }}</h6>
                                <h6 style="font-size: 12px;">Monthly: {{ monthly_maintenance_count }}</h6>
                                <h6 style="font-size: 12px;">Biannual: {{ biannual_maintenance_count }}</h6>
                                <h6 style="font-size: 12px;">Annual: {{ annual_maintenance_count }}</h6>
                            </div>
                        </div>
                    </div>
                </div>
            </div><!-- End Maintenance by Frequency Card -->

            <!-- Work Orders Card -->
            <div class="col-xxl-3 col-md-4">
                <div class="card info-card customers-card">
                    <div class="card-body">
                        <h5 class="card-title" style="font-size: 14px;">Work Orders</h5>
                        <p class="card-subtitle mb-2 text-muted" style="font-size: 12px;">{{ from_date }} to {{ to_date }}</p>
                        <div class="d-flex align-items-center">
                            <div class="card-icon rounded-circle d-flex align-items-center justify-content-center" style="font-size: 14px;">
                                <i class="bi bi-clipboard-check"></i>
                            </div>
                            <div class="ps-3">
                                <h6 style="font-size: 12px;">Pending: {{ pending_work_orders }}</h6>
                                <h6 style="font-size: 12px;">Completed: {{ completed_work_orders }}</h6>
                            </div>
                        </div>
                    </div>
                </div>
            </div><!-- End Work Orders Card -->
        </div>

        <!-- Graphs Section -->
        <div class="row mt-4">
            <!-- Maintenance by Month (Bar Chart) -->
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title" style="font-size: 14px;">Maintenance by Month</h5>
                        <canvas id="maintenanceByMonthChart" style="max-height: 300px;"></canvas>
                    </div>
                </div>
            </div><!-- End Maintenance by Month -->

            <!-- Work Orders by Month (Bar Chart) -->
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title" style="font-size: 14px;">Work Orders by Month</h5>
                        <canvas id="workOrdersByMonthChart" style="max-height: 300px;"></canvas>
                    </div>
                </div>
            </div><!-- End Work Orders by Month -->

            <!-- Maintenance by Month Graph -->
            <div class="row mt-4">
                <div class="col-lg-12">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title" style="font-size: 14px;">Equipment Maintenance by Type and Month</h5>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <select class="form-select form-select-sm" id="equipmentSelect">
                                        <option value="">Select Equipment</option>
                                        {% for equipment in equipment_list %}
                                        <option value="{{ equipment.id }}">{{ equipment.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <!-- Horizontal scrolling container -->
                            <div style="overflow-x: auto; overflow-y: hidden; width: 100%;">
                                <div style="min-width: 800px; height: 400px; padding-bottom: 20px;">
                                    <canvas id="equipmentMaintenanceByTypeChart" style="display: block; height: 380px; width: 100%;"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Maintenance by Frequency (Pie Chart) -->
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title" style="font-size: 14px;">Maintenance by Frequency</h5>
                        <canvas id="maintenanceByFrequencyChart" style="max-height: 300px;"></canvas>
                    </div>
                </div>
            </div><!-- End Maintenance by Frequency -->

            <!-- Spare Part Usage (Pie Chart) -->
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title" style="font-size: 14px;">Spare Part Usage</h5>
                        <canvas id="sparePartUsageChart" style="max-height: 300px;"></canvas>
                    </div>
                </div>
            </div><!-- End Spare Part Usage -->
        </div><!-- End Graphs Section -->
    </section>
</main><!-- End #main -->

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Maintenance by Month Chart
    const maintenanceByMonthCtx = document.getElementById('maintenanceByMonthChart').getContext('2d');
    const maintenanceByMonthChart = new Chart(maintenanceByMonthCtx, {
        type: 'bar',
        data: {
            labels: {{ maintenance_months|safe }},
            datasets: [{
                label: 'Maintenance Records',
                data: {{ maintenance_by_month_data|safe }},
                backgroundColor: 'rgba(54, 162, 235, 1)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            },
            plugins: {
                legend: {
                    labels: {
                        font: {
                            size: 10
                        }
                    }
                }
            }
        }
    });

    // Work Orders by Month Chart
    const workOrdersByMonthCtx = document.getElementById('workOrdersByMonthChart').getContext('2d');
    const workOrdersByMonthChart = new Chart(workOrdersByMonthCtx, {
        type: 'bar',
        data: {
            labels: {{ work_order_months|safe }},
            datasets: [
                {
                    label: 'Pending Work Orders',
                    data: {{ pending_work_orders_by_month|safe }},
                    backgroundColor: 'rgba(255, 99, 132, 1)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1
                },
                {
                    label: 'Completed Work Orders',
                    data: {{ completed_work_orders_by_month|safe }},
                    backgroundColor: 'rgba(75, 192, 192, 1)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }
            ]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            },
            plugins: {
                legend: {
                    labels: {
                        font: {
                            size: 10
                        }
                    }
                }
            }
        }
    });

    // Equipment Maintenance by Type and Month Chart - GROUPED BARS VERSION
const equipmentMaintenanceCtx = document.getElementById('equipmentMaintenanceByTypeChart');
if (equipmentMaintenanceCtx) {
    const equipmentMaintenanceChart = new Chart(equipmentMaintenanceCtx.getContext('2d'), {
        type: 'bar',
        data: {
            labels: [], // Will be populated from API
            datasets: [] // Will be populated from API
        },
        options: {
            responsive: true,
            scales: {
                x: {
                    stacked: false, // Changed from true to false
                    title: {
                        display: true,
                        text: 'Month'
                    },
                    grid: {
                        display: false
                    }
                },
                y: {
                    stacked: false, // Changed from true to false
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Number of Maintenances'
                    },
                    ticks: {
                        precision: 0 // Only show whole numbers
                    }
                }
            },
            plugins: {
                tooltip: {
                    mode: 'index',
                    intersect: false
                },
                legend: {
                    position: 'bottom',
                    labels: {
                        font: {
                            size: 12
                        },
                        boxWidth: 12
                    }
                }
            },
            // This makes the bars group together by month
            datasets: {
                bar: {
                    barPercentage: 0.8, // Controls bar width within category
                    categoryPercentage: 0.8 // Controls space between categories
                }
            }
        }
    });

    


    // Equipment dropdown event
    document.getElementById('equipmentSelect')?.addEventListener('change', function() {
        const equipmentId = this.value;
        const fromDate = document.getElementById('from_date').value;
        const toDate = document.getElementById('to_date').value;

        if (!equipmentId) {
            equipmentMaintenanceChart.data.labels = [];
            equipmentMaintenanceChart.data.datasets = [];
            equipmentMaintenanceChart.update();
            return;
        }

        fetch(`/api/equipment-maintenance-types/?equipment_id=${equipmentId}&from_date=${fromDate}&to_date=${toDate}`)
            .then(response => response.json())
            .then(data => {
                equipmentMaintenanceChart.data.labels = data.labels;
                equipmentMaintenanceChart.data.datasets = data.datasets;
                equipmentMaintenanceChart.update();
            })
            .catch(error => {
                console.error('Error:', error);
                // Display error message to user if needed
            });
    });
}

    // Maintenance by Frequency Chart
    const maintenanceByFrequencyCtx = document.getElementById('maintenanceByFrequencyChart').getContext('2d');
    const maintenanceByFrequencyChart = new Chart(maintenanceByFrequencyCtx, {
        type: 'pie',
        data: {
            labels: ['Daily', 'Weekly', 'Monthly', 'Biannual', 'Annual'],
            datasets: [{
                data: [
                    {{ daily_maintenance_count }},
                    {{ weekly_maintenance_count }},
                    {{ monthly_maintenance_count }},
                    {{ biannual_maintenance_count }},
                    {{ annual_maintenance_count }}
                ],
                backgroundColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(153, 102, 255, 1)',
                    'rgba(255, 159, 64, 1)'
                ],
                borderColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(153, 102, 255, 1)',
                    'rgba(255, 159, 64, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            plugins: {
                legend: {
                    labels: {
                        font: {
                            size: 10
                        }
                    }
                }
            }
        }
    });

    // Spare Part Usage Chart
    const sparePartUsageCtx = document.getElementById('sparePartUsageChart').getContext('2d');
    const sparePartUsageChart = new Chart(sparePartUsageCtx, {
        type: 'pie',
        data: {
            labels: {{ spare_part_labels|safe }},
            datasets: [{
                data: {{ spare_part_usage_data|safe }},
                backgroundColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(153, 102, 255, 1)',
                    'rgba(255, 159, 64, 1)'
                ],
                borderColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(153, 102, 255, 1)',
                    'rgba(255, 159, 64, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            plugins: {
                legend: {
                    labels: {
                        font: {
                            size: 10
                        }
                    }
                }
            }
        }
    });
</script>
{% endblock %}